<!DOCTYPE HTML>
<html>
<head>
<title>BIXI2D</title>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

<meta property="og:url"         content="http://bixi.life/sim" />
<meta property="og:title"       content="BIXI909: Simulator" />
<meta property="og:description" content="Moonwalk Mission 2017" />
<meta property="og:image"       content="http://bixi.life/bixi.jpg" />

<style>
    body {
        background:#777;
        padding:0;
        margin:0;
        font-weight: bold;
        overflow:hidden;
    }

    #caption {
      position: absolute;
      left: 0;
      top: 50%;
      width: 100%;
      text-align: center;
      color: #000;
    }

    #caption span {
      background-color: #111;
      color: #fff;
      padding: 18px;
      margin: 18px;
      font-size: 25px;
      letter-spacing: 10px;

      display: inline-block;
    }

</style>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-41647925-4', 'auto');
  ga('send', 'pageview');

</script>

<script type="text/javascript" src="static/js/lib/threejs/three.min.js" ></script>
<script type="text/javascript" src="static/js/lib/threejs/stats.min.js" ></script>
<script type="text/javascript" src="static/js/lib/threejs/Detector.js" ></script>
<script type="text/javascript" src="static/js/lib/threejs/controls/OrbitControls.js" ></script>
<script type="text/javascript" src="static/js/lib/threejs/ColladaLoader2.js" ></script>

<script id="vertexShader" type="x-shader/x-vertex">
    // Custom vertex shader
    uniform vec3 viewVector;
    uniform float c;
    uniform float p;
    varying float intensity;
    void main() {
        vec3 vNormal = normalize( normalMatrix * normal );
        vec3 vNormel = normalize( normalMatrix * viewVector );
        intensity = pow( c - dot(vNormal, vNormel), p );

        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
    }
</script>

<script id="fragmentShader" type="x-shader/x-vertex"> 
    // Fragment shader, a.k.a. pixel shader
    uniform vec3 glowColor;
    varying float intensity;
    void main() {
        vec3 glow = glowColor * intensity;
        gl_FragColor = vec4( glow, 1.0 );
    }
</script>

</head>
<body>
    <div id="caption"></div>
    <div id="container"></div>

<script type="text/javascript">

if (!Detector.webgl) Detector.addGetWebGLMessage();

var container, stats;
var camera, scene, renderer, controls;

var LED_ARRAY = new Array(21);

var textureGlow  = THREE.ImageUtils.loadTexture('static/img/led1.png');
var texturePoint = THREE.ImageUtils.loadTexture('static/img/led4.png');
var textureOff   = THREE.ImageUtils.loadTexture('static/img/ledoff.png');

var materialGlow  = new THREE.SpriteMaterial({ map: textureGlow,  color: 0x0, transparent: true } );
var materialPoint = new THREE.SpriteMaterial({ map: texturePoint, color: 0x0, transparent: true } );
var materialOff   = new THREE.SpriteMaterial({ map: textureOff,   color: 0xffffff, transparent: true, opacity: 0.2} );

var s = 40;
var s2 = 15;

init();
animate();

function displayError(errorText) {
    var errorDiv = document.getElementById('caption');
    var newSpan = document.createElement('span');
    var error = "ERROR: " + errorText;
    newSpan.appendChild(document.createTextNode(error));
    errorDiv.appendChild(newSpan);
    console.log(error);
}

function init(){
    container = document.getElementById('container');

    camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 2000);
    camera.position.set(5, 7, 5);

    scene = new THREE.Scene();

    // Load the Bixi909 Collada model
    var loader = new THREE.ColladaLoader();
    loader.options.convertUpAxis = true;
    loader.load(
        "static/img/models/bixi-test.dae",
        function (collada) {

            var object = collada.scene;
            //object.scale.set(0.0025, 0.0025, 0.0025);
            object.position.set(0, 0, 0);

            // Access the LED parts of the object...
            for (var i=0; i<object.children[0].children.length; i++){
                var led = object.children[0].children[i];
                if (led.name.startsWith('led')) {

                    // All LEDs are prefixed with "led_", extract the number
                    // that's maintained by the sketchup model
                    var thisIndex = parseInt(led.name.slice(4));

                    // Create a new custom material and light for this LED that we push in
                    // to the LED_ARRAY object we use for controlling LED
                    // patterns
                    var randomColor = Math.random() * 0xffffff;
                    var ledLight = new THREE.PointLight(randomColor, 10, 2);
                    /*
                    var customMaterial = new THREE.ShaderMaterial({
                        uniforms: {
                            "c": { type: "f", value: 0.1 },
                            "p": { type: "f", value: 0.7 },
                            glowColor: { type: "c", value: new THREE.Color(randomColor) },
                            viewVector: { type: "v3", value: camera.position }
                        },
                        vertexShader: document.getElementById( 'vertexShader'   ).textContent,
                        fragmentShader: document.getElementById( 'fragmentShader' ).textContent,
                        side: THREE.FrontSide,
                        blending: THREE.AdditiveBlending,
                        transparent: false
                    });
                    */
                    var customMaterial = new THREE.MeshStandardMaterial( {
                        emissive: randomColor,
                        emissiveIntensity: 10,
                        color: randomColor
                    });

                    var sprite = new THREE.Sprite(materialOff);
                    sprite.position.copy(led.position);
                    sprite.scale.set(s2, s2, s2);
                    scene.add(sprite);

                    var sprite = new THREE.Sprite(materialGlow.clone());
                    sprite.position.copy(led.position);
                    sprite.scale.set(s, s, s);
                    scene.add(sprite);

                    // Swap sketchup's material for this one
                    led.material = customMaterial;

                    // Ideally we've defined the LED array correctly in the
                    // sketchup model such that each has a unique index. Here
                    // we check that we haven't already defined a reference to
                    // this LED before sticking it in the array. This pushes the
                    // responsibility for mainting the 
                    if (LED_ARRAY[thisIndex] === undefined) {
                        LED_ARRAY[thisIndex] = {
                            'material': customMaterial,
                            'mesh': led,
                            'light': ledLight
                        }
                    }
                    else {
                        displayError("LED with index " + thisIndex + " has already been defined!");
                    }
                }
            }

            // Iterate over the LED_ARRAY and verify that we've loaded materials
            // for ALL leds
            for (var i=0; i<LED_ARRAY.length; i++) {
                if (LED_ARRAY[i] === undefined) {
                    displayError("LED with index " + i + " was never defined!!!");
                }
                else {
                    var led = LED_ARRAY[i];
                    led.light.name = led.mesh.name;
                    led.mesh.add(led.light);
                    led.light.position.copy(led.mesh.position);
                    led.mesh.material.needsUpdate = true;
                    scene.add(led.light);

                    console.log(led.mesh);
                    console.log(led.light);
                }
            }


            console.log("Adding object...");
            scene.add(object);
            console.log("done");

        }
    );

    // Add floor
    var gridHelper = new THREE.GridHelper(10, 20);
    scene.add(gridHelper);

    // Add lighting
    //var ambientLight = new THREE.AmbientLight(0xcccccc);
    //scene.add(ambientLight);

    var directionalLight = new THREE.DirectionalLight(0xffffff);
    directionalLight.position.set(0, 1, -1).normalize();
    scene.add(directionalLight);

    // Add renderer
    renderer = new THREE.WebGLRenderer();
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement);

    // Add control
    controls = new THREE.OrbitControls(camera, renderer.domElement);

    // Add stats tracking object
    stats = new Stats();
    container.appendChild(stats.dom);

    // Add resize callback
    window.addEventListener('resize', onWindowResize, false);
}

function onWindowResize() {

    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();

    renderer.setSize(window.innerWidth, window.innerHeight);

}

function animate(){
    requestAnimationFrame(animate);

    render();
    stats.update();
}

function render() {
    renderer.render( scene, camera );
}

    </script>

</body>
</html>
